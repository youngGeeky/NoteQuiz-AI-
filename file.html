<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteQuiz AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg-white: #F8F9FA;
            --light-grey: #E9ECEF;
            --dark-grey: #495057;
            --blue: #0D6EFD;
            --green: #198754;
            --red: #DC3545;
            --text-main: #212529;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-white);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            width: 90%;
            max-width: 650px;
        }

        h1 { color: var(--blue); text-align: center; margin-bottom: 1.5rem; }

        textarea {
            width: 100%;
            height: 180px;
            padding: 15px;
            border: 2px solid var(--light-grey);
            border-radius: 10px;
            resize: none;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
        }

        textarea:focus { border-color: var(--blue); outline: none; }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        input[type="number"] {
            padding: 10px;
            border: 2px solid var(--light-grey);
            border-radius: 8px;
            width: 70px;
            text-align: center;
        }

        button {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:active { transform: scale(0.98); }
        button:hover { opacity: 0.9; }

        .option-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 15px;
            margin: 10px 0;
            background: var(--bg-white);
            border: 2px solid var(--light-grey);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            color: black;;
        }

        .option-btn:hover { border-color: var(--blue); background: #f0f7ff; }
        .option-btn.selected { background: var(--blue); color: white; border-color: var(--blue); }

        #score-page { text-align: center; }
        .status-icon { font-size: 100px; margin-bottom: 20px; }
        .green { color: var(--green); }
        .red { color: var(--red); }

        .hidden { display: none; }
        #loading { text-align: center; font-weight: bold; color: var(--blue); }

        .summary-section { margin-top: 2rem; text-align: left; }
        .summary-section h3 { color: var(--blue); margin-bottom: 1rem; border-bottom: 2px solid var(--light-grey); padding-bottom: 0.5rem; }
        .summary-item { background: var(--bg-white); padding: 1rem; margin-bottom: 1rem; border-radius: 10px; border-left: 4px solid var(--light-grey); }
        .summary-item.correct { border-left-color: var(--green); }
        .summary-item.incorrect { border-left-color: var(--red); }
        .question-text { font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; }
        .answer-info { font-size: 0.95rem; color: var(--dark-grey); }
        .user-answer { color: var(--blue); margin: 0.3rem 0; }
        .correct-answer { color: var(--green); margin: 0.3rem 0; }
        .incorrect-answer { color: var(--red); margin: 0.3rem 0; }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 2px solid var(--light-grey);
            border-radius: 8px;
            margin-bottom: 1rem;
            box-sizing: border-box;
            cursor: pointer;
            font-size: 0.95rem;
            background-color: var(--bg-white);
            transition: border-color 0.2s, background-color 0.2s;
        }

        input[type="file"]:hover {
            border-color: var(--blue);
            background-color: #f0f7ff;
        }

        input[type="file"]:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }

        .file-upload-section {
            margin-bottom: 1.5rem;
        }

        .file-upload-section label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        #file-status {
            margin: 0;
            font-size: 0.9rem;
            color: var(--blue);
            display: none;
            padding: 8px 12px;
            background-color: rgba(13, 110, 253, 0.1);
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        #file-status.error {
            color: var(--red);
            background-color: rgba(220, 53, 69, 0.1);
        }

    </style>
</head>
<body>

<div class="container">
    <!-- SETUP SCREEN -->
    <div id="input-section">
        <h1>Note to Quiz</h1>
        <div class="file-upload-section">
            <label for="file-upload">Upload File or Paste Notes</label>
            <input type="file" id="file-upload" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg">
            <p id="file-status"></p>
        </div>
        <p style="text-align: center; color: var(--dark-grey); margin: 1rem 0;">OR</p>
        <textarea id="note-input" placeholder="Paste your study notes or a topic description here..."></textarea>
        <div class="controls">
            <span>Questions:</span>
            <input type="number" id="num-questions" value="3" min="1" max="100">
            <button onclick="generateQuiz()">Generate Quiz</button>
        </div>
        <p id="loading" class="hidden">ü§ñ AI is thinking... please wait.</p>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quiz-section" class="hidden">
        <div id="progress" style="font-size: 0.9rem; color: gray; margin-bottom: 10px;"></div>
        <h2 id="q-text"></h2>
        <div id="options-container"></div>
        <div style="text-align: right; margin-top: 20px;">
            <button id="next-btn" class="hidden" onclick="handleNext()">Next Question ‚Üí</button>
        </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="score-page" class="hidden">
        <div id="result-icon" class="status-icon"></div>
        <h2 id="score-text"></h2>
        <p id="feedback-text"></p>
        <div class="summary-section" id="summary-container"></div>
        <button onclick="location.reload()" style="background: var(--dark-grey); width: 100%; margin-top: 1rem;">Start Over</button>
    </div>
</div>


<script>
    let quizData = [];
    let currentIdx = 0;
    let score = 0;
    let selectedAnswer = null;
    let userAnswers = [];
    let uploadedFileContent = null;

    // Handle file upload
    document.getElementById('file-upload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const fileStatus = document.getElementById('file-status');
        fileStatus.style.display = 'block';
        fileStatus.classList.remove('error');
        fileStatus.innerText = 'üìÑ Processing file...';

        try {
            uploadedFileContent = await extractTextFromFile(file);
            fileStatus.innerText = `‚úÖ File loaded: ${file.name}`;
            fileStatus.classList.remove('error');
            document.getElementById('note-input').value = '';
        } catch (error) {
            fileStatus.innerText = `‚ùå Error reading file: ${error.message}`;
            fileStatus.classList.add('error');
            uploadedFileContent = null;
        }
    });

    async function extractTextFromFile(file) {
        const fileType = file.type;
        const fileName = file.name.toLowerCase();

        if (fileName.endsWith('.txt')) {
            return await file.text();
        } else if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
            return await extractPDFText(file);
        } else if (fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                   fileType === 'application/msword' || 
                   fileName.endsWith('.docx') || 
                   fileName.endsWith('.doc')) {
            return await extractWordText(file);
        } else if (fileType === 'image/png' || fileType === 'image/jpeg' || 
                   fileName.endsWith('.png') || 
                   fileName.endsWith('.jpg') || 
                   fileName.endsWith('.jpeg')) {
            return await extractImageText(file);
        } else {
            throw new Error('Unsupported file type. Please use PDF, Word, TXT, PNG, or JPG files.');
        }
    }

    async function extractPDFText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = '';

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            text += pageText + ' ';
        }

        return text.trim();
    }

    async function extractWordText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        return result.value;
    }

    async function extractImageText(file) {
        const url = URL.createObjectURL(file);
        try {
            const result = await Tesseract.recognize(url, 'eng', {
                logger: (m) => {
                    if (m.status === 'recognizing text') {
                        console.log(`OCR Progress: ${Math.round(m.progress * 100)}%`);
                    }
                }
            });
            return result.data.text;
        } finally {
            URL.revokeObjectURL(url);
        }
    }

    async function generateQuiz() {
        const fileText = uploadedFileContent;
        const textareaText = document.getElementById('note-input').value;
        const text = fileText || textareaText;
        const count = parseInt(document.getElementById('num-questions').value, 10) || 3;

        if (!text) {
            alert('Please upload a file or paste your notes before generating the quiz.');
            return;
        }

        const prompt = `Convert the following notes into exactly ${count} multiple-choice questions. 
        Return ONLY a raw JSON array. 
        Format: [{"question": "...", "option1": "...", "option2": "...", "option3": "...", "option4": "...", "answer": 1}]
        The 'answer' key must be a number (1, 2, 3, or 4) corresponding to the correct option.
        Notes: ${text}`

        document.getElementById('loading').classList.remove('hidden');

        try {
            const resp = await fetch('/generate-quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error || 'Generation failed');

            let quiz = null;

            if (data.candidates && data.candidates[0]) {
                const rawText = data.candidates[0].content?.parts?.[0]?.text || '';
                const jsonMatch = rawText.match(/\[.*\]/s);
                if (!jsonMatch) throw new Error('AI did not return valid JSON');
                quiz = JSON.parse(jsonMatch[0]);
            }

            if (!Array.isArray(quiz) || quiz.length === 0) throw new Error('Empty quiz returned');

            quizData = quiz;
            startQuiz();
        } catch (error) {
            console.error('generateQuiz error', error);
            alert('Error: ' + (error.message || String(error)));
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    function startQuiz() {
        document.getElementById('input-section').classList.add('hidden');
        document.getElementById('quiz-section').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        const q = quizData[currentIdx];
        document.getElementById('progress').innerText = `Question ${currentIdx + 1} of ${quizData.length}`;
        document.getElementById('q-text').innerText = q.question;
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        selectedAnswer = null;
        document.getElementById('next-btn').classList.add('hidden');

        [1, 2, 3, 4].forEach(num => {
            const optionText = q[`option${num}`];
            if (optionText) {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = optionText;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedAnswer = num;
                    document.getElementById('next-btn').classList.remove('hidden');
                };
                container.appendChild(btn);
            }
        });
    }

    function handleNext() {
        userAnswers.push(selectedAnswer);
        
        if (selectedAnswer == quizData[currentIdx].answer) {
            score++;
        }

        currentIdx++;
        if (currentIdx < quizData.length) {
            showQuestion();
        } else {
            showResult();
        }
    }

    function showResult() {
        document.getElementById('quiz-section').classList.add('hidden');
        document.getElementById('score-page').classList.remove('hidden');
        
        const percentage = (score / quizData.length) * 100;
        const icon = document.getElementById('result-icon');
        const scoreText = document.getElementById('score-text');

        scoreText.innerText = `You got ${score} / ${quizData.length}`;

        if (percentage >= 50) {
            icon.innerHTML = '‚úîÔ∏è';
            icon.className = 'status-icon green';
            document.getElementById('feedback-text').innerText = "Great job! You passed!";
        } else {
            icon.innerHTML = '‚ùå';
            icon.className = 'status-icon red';
            document.getElementById('feedback-text').innerText = "Keep studying and try again.";
        }

        displaySummary();
    }

    function displaySummary() {
        const summaryContainer = document.getElementById('summary-container');
        let summaryHTML = '<h3>Review Your Answers</h3>';

        quizData.forEach((q, idx) => {
            const userAnswer = userAnswers[idx];
            const correctAnswer = q.answer;
            const isCorrect = userAnswer === correctAnswer;
            const itemClass = isCorrect ? 'correct' : 'incorrect';

            summaryHTML += `
                <div class="summary-item ${itemClass}">
                    <div class="question-text">Q${idx + 1}: ${q.question}</div>
                    <div class="answer-info">
                        <div class="user-answer">
                            Your answer: <strong>${q[`option${userAnswer}`] || 'Not answered'}</strong>
                        </div>
                        <div class="${isCorrect ? 'correct-answer' : 'incorrect-answer'}">
                            Correct answer: <strong>${q[`option${correctAnswer}`]}</strong>
                        </div>
                    </div>
                </div>
            `;
        });

        summaryContainer.innerHTML = summaryHTML;
    }
</script>

</body>
</html>